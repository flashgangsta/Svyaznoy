package com.svyaznoy {	import flash.display.Sprite;	import flash.events.Event;	import flash.utils.Dictionary;		/**	 * ...	 * @author Sergey Krivtsov (flashgangsta@gmail.com)	 */	public class ProfilePhotos extends Sprite {				private const MARGIN:int = 30;				/// Список списков данных о фотографиях отсортированный по идентификатору выезда		private var photosDataByDepartureID:Dictionary = new Dictionary();		/// Список блоков с выездами отсортированный по идентификатору выезда		private var departuresBarsByID:Dictionary = new Dictionary();		/// Список данных о всех существующих выездах		private var departuresDatasList:Array;		/// Список данных о всех существующих у пользователя фотографиях		private var photosDataList:Array;				public function ProfilePhotos() {					}				/**		 * 		 * @param	photosDataList		 */				public function init( photosDataList:Array, departuresDatasList:Array ):void {			this.photosDataList = photosDataList;			this.departuresDatasList = departuresDatasList;						// Сортируем фотографии по выездам			for ( var i:int = 0; i < photosDataList.length; i++ ) {				initNewPhotoData( photosDataList[ i ] );			}						showPhotos();		}				/**		 * 		 * @param	departuresDatasList		 */				public function setDepartures( departuresDatasList:Array ):void {			var departureBar:ProfilePhotosDepartureBar; 			var data:Object;			var departureID:String;						this.departuresDatasList = departuresDatasList;						if ( photosDataByDepartureID ) {				for ( var i:int = 0; i < photosDataList.length; i++ ) {					data = photosDataList[ i ];					departureID = data.departure_id;					data.departureName = getDepartureNameByID( departureID );				}								for ( i = 0; i < numChildren; i++ ) {					departureBar = getChildAt( i ) as ProfilePhotosDepartureBar;					departureBar.setLabel();					departureBar.visible = true;				}				dispatchEvent( new Event( Event.RESIZE ) );			}		}				/**		 * Перемещает фото из одного выезда в другой		 * @param	editedPhotoPreview		 */				public function changePhotoDeparture( editedPhotoPreview:PreviewDepartureImage ):void {			var data:Object = editedPhotoPreview.getData();			var newDepartureID:String = data.departure_id;			var newDepartureName:String = getDepartureNameByID( newDepartureID );			var newDepartureBar:ProfilePhotosDepartureBar =  departuresBarsByID[ newDepartureID ];			var newPhotosDataList:Vector.<Object> = photosDataByDepartureID[ newDepartureID ];						// Удаляем старое фото			deletePhoto( editedPhotoPreview );						// проверяем существует ли раздел с новым выездом			if ( !newDepartureBar ) {				// Если раздела не существует, создаем его				initNewPhotoData( data );				newDepartureBar = createDepartureBar( photosDataByDepartureID[ newDepartureID ], false );				addChild( newDepartureBar );			} else {				data.departureName = getDepartureNameByID( newDepartureID );				newPhotosDataList.push( data );			}						newDepartureBar.movePhoto( editedPhotoPreview );			alignBars();		}								/**		 * 		 * @param	deletedPhotoPreview		 */				public function deletePhoto( deletedPhotoPreview:PreviewDepartureImage ):void {			var data:Object = deletedPhotoPreview.getData();			var bar:ProfilePhotosDepartureBar = getBarByPhoto( deletedPhotoPreview );			var departureID:String = bar.getDepartureID();			var dataList:Vector.<Object> = photosDataByDepartureID[ departureID ];						dataList.splice( dataList.indexOf( data ), 1 );			removePhotoFromBar( deletedPhotoPreview );			alignBars();		}				/**		 * 		 * @param	newPhotoData		 */				public function addNewPhoto( data:Object ):void {			var departureID:String = data.departure_id;			var bar:ProfilePhotosDepartureBar = departuresBarsByID[ departureID ];			initNewPhotoData( data );						// проверяем существует ли раздел с новым выездом			if ( !bar ) {				// Если раздела не существует, создаем его				bar = createDepartureBar(  photosDataByDepartureID[ departureID ] );				addChild( bar );			} else {				bar.addPhoto( data );			}			alignBars();		}				/**		 * 		 * @param	data		 */				private function initNewPhotoData( data:Object ):void {			var departureID:String = data.departure_id;			data.departureName = getDepartureNameByID( departureID );			if ( !photosDataByDepartureID[ departureID ] ) {				photosDataByDepartureID[ departureID ] = new Vector.<Object>();			}			photosDataByDepartureID[ departureID ].push( data );		}				/**		 * Позиционирует блоки с выездами		 */				private function alignBars():void {			trace( "alignBars()" );			var bar:ProfilePhotosDepartureBar;			var lastBarY:int = 0;			for ( var i:int = 0; i < numChildren; i++ ) {				bar = getChildAt( i ) as ProfilePhotosDepartureBar;				bar.y = lastBarY;				lastBarY += bar.height + MARGIN;			}			dispatchEvent( new Event( Event.RESIZE ) );		}				/**		 * 		 */				private function removePhotoFromBar( photo:PreviewDepartureImage ):void {			var bar:ProfilePhotosDepartureBar = getBarByPhoto( photo );			bar.removePhoto( photo );			if( !bar.numPhotos ) {				//Если список пуст, удаляем его за ненаобностью				removeBar( bar );			}		}				/**		 * 		 * @param	photo		 * @return		 */				private function getBarByPhoto( photo:PreviewDepartureImage ):ProfilePhotosDepartureBar {			return photo.parent.parent as ProfilePhotosDepartureBar;		}				/**		 * 		 * @param	bar		 */				private function removeBar( bar:ProfilePhotosDepartureBar ):void {			var barDepartureID:String = bar.getDepartureID();			delete photosDataByDepartureID[ barDepartureID ];			delete departuresBarsByID[ barDepartureID ];			bar.dispose();			removeChild( bar );			bar = null;		}				/**		 * 		 * @param	id		 */				private function getDepartureNameByID( id:String ):String {			var result:String = id;			if ( departuresDatasList ) {				for each( var data:Object in departuresDatasList ) {					if ( data.id === id ) {						result = data.title;						break;					}				}			}			return result;		}				/**		 * 		 */				private function showPhotos():void {			for each( var departureList:Vector.<Object> in photosDataByDepartureID ) {				var departureBar:ProfilePhotosDepartureBar = createDepartureBar( departureList );				addChild( departureBar );			}						trace( hasEventListener( Event.ADDED_TO_STAGE ) );						if ( !hasEventListener( Event.ADDED_TO_STAGE ) ) {				addEventListener( Event.ADDED_TO_STAGE, onAddedToStage );			}						if ( stage ) {				alignBars();			}		}				/**		 * 		 * @param	event		 */				private function onAddedToStage( event:Event ):void {			trace( "onProfilePhotosAddedToStage" );			removeEventListener( Event.ADDED_TO_STAGE, onAddedToStage );			alignBars();		}				/**		 * 		 * @return		 */				private function createDepartureBar( photosDataList:Vector.<Object>, loadPhotos:Boolean = true ):ProfilePhotosDepartureBar {			var bar:ProfilePhotosDepartureBar = new ProfilePhotosDepartureBar( photosDataList, loadPhotos );			departuresBarsByID[ bar.getDepartureID() ] = bar;			bar.visible = Boolean( departuresDatasList );			return bar;		}			}}